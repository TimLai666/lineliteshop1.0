<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <!-- Tailwind CDN for lightweight styling (dev/prototype). For production, consider a build step. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Minimal custom overrides */
        body {
            font-family: Roboto, 'Noto Sans TC', Arial;
            padding: 12px;
            max-width: 300px;
        }

        #groupList {
            max-height: 10rem;
        }
    </style>
</head>

<body>
    <div class="p-4 w-full max-w-xs bg-gray-50 min-h-screen">
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700">分群依據</label>
                <select id="fieldSelect" onchange="onFieldChange()"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></select>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">選擇分群（可多選）</label>
                <div id="groupList" class="mt-2 max-h-40 overflow-auto border rounded p-2 bg-white text-sm">載入中...</div>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">發送方式</label>
                <select id="channelSelect" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    <option value="email">Email</option>
                    <option value="line">LINE</option>
                </select>
                <div id="recipientInfo" class="text-xs text-gray-500 mt-2"></div>
            </div>

            <div id="emailFields" class="">
                <label class="block text-sm font-medium text-gray-700">主旨</label>
                <input type="text" id="subjectInput" placeholder="Email 主旨"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">訊息內容</label>
                <div class="mt-2 flex flex-wrap gap-2">
                    <button type="button"
                        class="inline-flex items-center px-3 py-1 rounded-full bg-gray-100 text-xs border"
                        onclick="insertToken('{{customerName}}')">顧客姓名</button>
                    <button type="button"
                        class="inline-flex items-center px-3 py-1 rounded-full bg-gray-100 text-xs border"
                        onclick="insertToken('{{customerEmail}}')">顧客 Email</button>
                    <button type="button"
                        class="inline-flex items-center px-3 py-1 rounded-full bg-gray-100 text-xs border"
                        onclick="insertToken('{{customerPhone}}')">顧客電話</button>
                    <button type="button"
                        class="inline-flex items-center px-3 py-1 rounded-full bg-gray-100 text-xs border"
                        onclick="insertTodayDate()" title="插入今天日期">今天日期</button>
                    <button type="button"
                        class="inline-flex items-center px-3 py-1 rounded-full bg-gray-100 text-xs border"
                        onclick="insertNowTime()" title="插入現在時間">現在時間</button>
                </div>
                <textarea id="messageInput" rows="8" placeholder="在此撰寫內文，可使用上方按鈕插入變數"
                    class="mt-2 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
            </div>

            <div>
                <button class="mt-2 w-full bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700"
                    onclick="onSend()">發送</button>
            </div>

            <div class="mt-3 text-sm text-gray-700" id="summary"></div>
        </div>
    </div>

    <script>
        function init() {
            google.script.run.withSuccessHandler(populateFields).getGroupingFields();
            google.script.run.withSuccessHandler(setRecipientField).getLineRecipientField();
            document.getElementById('channelSelect').addEventListener('change', onChannelChange);
            onChannelChange();
        }

        function populateFields(fields) {
            const sel = document.getElementById('fieldSelect');
            sel.innerHTML = '';
            fields.forEach(f => {
                const o = document.createElement('option');
                o.value = f; o.textContent = f;
                sel.appendChild(o);
            });
            onFieldChange();
        }

        function onFieldChange() {
            const field = document.getElementById('fieldSelect').value;
            const groupList = document.getElementById('groupList');
            groupList.textContent = '載入中...';
            google.script.run.withSuccessHandler(function (values) {
                renderGroupList(values);
            }).getDistinctGroupValues(field);
        }

        function renderGroupList(values) {
            const container = document.getElementById('groupList');
            container.innerHTML = '';
            if (!values || values.length === 0) {
                container.textContent = '找不到分群或該欄為空。';
                return;
            }
            values.forEach(v => {
                const id = 'g_' + v.replace(/\s+/g, '_');
                const cb = document.createElement('input');
                cb.type = 'checkbox'; cb.id = id; cb.value = v;
                cb.className = 'mr-2 h-4 w-4';
                const label = document.createElement('label');
                label.className = 'flex items-center gap-2 py-1 text-sm';
                label.appendChild(cb);
                label.appendChild(document.createTextNode(v));
                container.appendChild(label);
            });
        }

        function insertToken(token) {
            const ta = document.getElementById('messageInput');
            const start = ta.selectionStart || 0;
            const end = ta.selectionEnd || 0;
            const before = ta.value.substring(0, start);
            const after = ta.value.substring(end);
            ta.value = before + token + after;
            ta.focus();
            ta.selectionStart = ta.selectionEnd = start + token.length;
        }

        // 插入今天日期（使用使用者 locale）
        function insertTodayDate() {
            const d = new Date();
            // 範例輸出：2026/1/30 或 2026-01-30 會依系統 locale 顯示
            const s = d.toLocaleDateString();
            insertToken(s);
        }

        // 插入現在時間（含時分秒，使用者 locale）
        function insertNowTime() {
            const d = new Date();
            const s = d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            insertToken(s);
        }

        function escapeHtml(str) {
            if (!str) return '';
            return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        function onChannelChange() {
            const ch = document.getElementById('channelSelect').value;
            document.getElementById('emailFields').style.display = ch === 'email' ? 'block' : 'none';
        }

        function setRecipientField(field) {
            document.getElementById('recipientInfo').textContent = 'LINE 目標欄位：' + field + '（可在設定表修改 `line_recipient_field`）';
        }

        function onSend() {
            const field = document.getElementById('fieldSelect').value;
            const checkboxes = document.querySelectorAll('#groupList input[type=checkbox]:checked');
            const groups = Array.from(checkboxes).map(cb => cb.value);
            const channel = document.getElementById('channelSelect').value;
            const subject = document.getElementById('subjectInput').value;
            const message = document.getElementById('messageInput').value;

            document.getElementById('summary').textContent = '發送中...';
            google.script.run.withSuccessHandler(function (resp) {
                if (resp.status === 'success') {
                    const ok = resp.results.filter(r => r.status === 'sent').length;
                    const skipped = resp.results.filter(r => r.status === 'skipped').length;
                    const err = resp.results.filter(r => r.status === 'error').length;
                    let html = `發送完成 ✅ 成功 ${ok}，跳過 ${skipped}，錯誤 ${err}`;
                    html += '<ul style="margin-top:8px;padding-left:18px">';
                    resp.results.forEach(r => {
                        let line = `<li><strong>${escapeHtml(r.name || r.id)}</strong> — ${r.status}`;
                        if (r.reason) line += `：${escapeHtml(r.reason)}`;
                        if (r.responseCode) line += `（HTTP ${r.responseCode}）`;
                        line += '</li>';
                        html += line;
                    });
                    html += '</ul>';
                    document.getElementById('summary').innerHTML = html;
                } else {
                    document.getElementById('summary').textContent = '錯誤：' + resp.message;
                }
            }).sendMessages({ fieldName: field, groups: groups, channel: channel, subject: subject, message: message });
        }

        window.addEventListener('load', init);
    </script>
</body>

</html>